Bootstrap: docker
From: nvidia/cuda:12.6.3-base-ubuntu24.04

%post
    #!/bin/bash

    # keep apt install happy
    echo _ssh:x:101: >> /etc/group

    DEBIAN_FRONTEND=noninteractive \
    apt-get update --quiet \
    && apt-get install --yes --quiet python3.12 python3-pip python3.12-venv python3.12-dev \
    && apt-get install --yes --quiet perl git wget gcc g++ make zlib1g-dev zstd
        # Verify Python installation
    which python3

    # keep git submodules happy
    export HOME=/root
    git config --global --add safe.directory '*'

    python3 -m venv /alphafold3_venv
    export PATH="/hmmer/bin:/alphafold3_venv/bin:$PATH"

    pip3 install --no-cache-dir --upgrade pip

    mkdir /hmmer_build /hmmer
    wget http://eddylab.org/software/hmmer/hmmer-3.4.tar.gz --directory-prefix /hmmer_build
    (cd /hmmer_build && echo "ca70d94fd0cf271bd7063423aabb116d42de533117343a9b27a65c17ff06fbf3 hmmer-3.4.tar.gz" | sha256sum --check) && \
    (cd /hmmer_build && tar zxf hmmer-3.4.tar.gz && rm hmmer-3.4.tar.gz)
    (cd /hmmer_build/hmmer-3.4 && ./configure --prefix /hmmer && make -j $(nproc) && make install)
    (cd /hmmer_build/hmmer-3.4/easel && make install)
    rm -R /hmmer_build

    git clone https://github.com/google-deepmind/alphafold3.git /app/alphafold
    cd /app/alphafold
    pip3 install --no-cache-dir setuptools \
    && pip3 install --no-cache-dir -r dev-requirements.txt \
    && pip3 install --no-cache-dir --no-deps .

    build_data

%environment
    export XLA_FLAGS="--xla_gpu_enable_triton_gemm=false"
    export XLA_PYTHON_CLIENT_PREALLOCATE=true
    export XLA_CLIENT_MEM_FRACTION=0.95

%runscript
    export PATH="/hmmer/bin:/alphafold3_venv/bin:$PATH"
    exec python3 /app/alphafold/run_alphafold.py "$@"
